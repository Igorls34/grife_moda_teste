<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Parser Whats → products[]</title>
<style>
  :root{--line:#e5e7eb;--muted:#6b7280;--bg:#0b1220}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:1}
  header h1{margin:0;font-size:18px}
  main{padding:16px;display:grid;gap:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  textarea{width:100%;min-height:220px;padding:10px;border:1px solid var(--line);border-radius:10px}
  .card{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
  label{font-size:14px;color:#111}
  input,select{padding:8px 10px;border:1px solid var(--line);border-radius:10px}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
  th,td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left;font-size:14px;vertical-align:top}
  th{background:#f8fafc}
  .muted{color:var(--muted);font-size:13px}
  .btn{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .btn-primary{background:#111;color:#fff;border-color:#111}
  .btn-accent{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  .tools{display:flex;gap:8px;flex-wrap:wrap}
  .ok{background:#10b981;color:#fff;border-color:#10b981}
  footer{margin-top:20px;padding:12px;text-align:center;background:#f8fafc;border-top:1px solid var(--line)}
  code{background:#f3f4f6;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<header><h1>Whats → products[] (Grife Moda)</h1></header>
<main>
  <section class="card">
    <div class="row">
      <div style="flex:1 1 260px">
        <label for="raw">Cole aqui os blocos do Whats (1 produto por bloco, ou separados por <code>---</code>)</label>
        <textarea id="raw" placeholder="SKU: GM-TS-002
Nome: Camiseta Oversized Off-White
Preço (ex 89.90): 89.90
Tamanhos (ex P,M,G,GG): M,G,GG
Cor: Off-White
Destaque? (sim/não): sim
Descrição (opcional): Malha premium."></textarea>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Base das imagens</label><br>
        <input id="imgBasePath" value="./assets/fotos/">
        <span class="muted">ex.: <code>./assets/fotos/</code></span>
      </div>
      <div>
        <label>Formato da imagem</label><br>
        <select id="imgFormat">
          <option value="image">image (uma .webp)</option>
          <option value="imageBase">imageBase (-600/-1200.webp)</option>
        </select>
      </div>
      <div>
        <label>Extensão</label><br>
        <select id="imgExt">
          <option>.webp</option>
          <option>.jpg</option>
          <option>.png</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label><br>
        <button class="btn btn-primary" id="btn-parse">Parsear</button>
      </div>
    </div>
    <p class="muted">Dica: preço pode vir como <code>R$ 129,90</code> ou <code>129.90</code>; tamanhos <code>P,M,G</code>. “Destaque? sim” vira <code>true</code>.</p>
  </section>

  <section id="results" class="card" style="display:none">
    <div class="tools">
      <button class="btn btn-accent" id="btn-copy">Copiar JS (products[])</button>
      <button class="btn" id="btn-download">Baixar JSON</button>
      <span class="muted" id="count"></span>
    </div>
    <div id="warn" class="muted" style="margin-top:8px"></div>
    <table id="table">
      <thead>
        <tr>
          <th>SKU</th><th>Nome</th><th>Preço</th><th>Tamanhos</th><th>Cor</th><th>Highlight</th><th>Slug</th><th>Arquivo de imagem (editável)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<footer>
  Feito pra você colar no <code>main.js</code>. Padrão de arquivo: sem acentos/espaços, minúsculo, com hífen.
</footer>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function slugify(s) {
  return String(s||"")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/-+/g,"-").replace(/^-|-$/g,"")
    .replace(/-off-white/g,"-offwhite");
}
function toPrice(str){
  if(!str) return 0;
  const only = String(str).replace(/[^\d.,]/g,"");
  // remove separador de milhar e normaliza decimal
  const norm = only.replace(/\.(?=\d{3}(?:\D|$))/g,"").replace(",",".");
  return parseFloat(norm) || 0;
}
function splitBlocks(text){
  const t = text.replace(/\r/g,"").trim();
  if(!t) return [];
  // prioridade: separador --- ; senão tente por início de "SKU:"
  let blocks = t.split(/\n-{3,}\n/).filter(b => b.trim());
  if(blocks.length === 1 && (t.match(/\nSKU\s*:/gi)||[]).length > 1){
    blocks = t.split(/\n(?=SKU\s*:)/i);
  }
  return blocks;
}
function pick(b, label) {
  // pega a linha iniciando com o rótulo
  const re = new RegExp("^" + label + "\\s*:\\s*(.+)$","im");
  const m = b.match(re);
  return m ? m[1].trim() : "";
}
function guessImageFromName(name, ext) {
  return slugify(name) + ext; // ex.: camiseta-oversized-offwhite.webp
}
function parseProducts(raw){
  const blocks = splitBlocks(raw);
  const out = [];
  const issues = [];
  blocks.forEach((b, i) => {
    const sku = pick(b,"SKU");
    const name = pick(b,"Nome");
    const priceStr = pick(b,"Preço.*?");
    const sizesStr = pick(b,"Tamanhos.*?");
    const color = pick(b,"Cor");
    const highStr = pick(b,"Destaque\\?\\s*\\(.*?\\)");
    const desc = pick(b,"Descrição.*?"); // opcional

    const price = toPrice(priceStr);
    const sizes = sizesStr ? sizesStr.split(/\s*,\s*/).filter(Boolean) : [];
    const highlight = /^sim$/i.test(highStr);

    if(!sku || !name) { issues.push(`Bloco ${i+1}: faltando SKU ou Nome.`); }

    out.push({ sku, name, price, sizes, color, highlight, desc });
  });
  return { items: out, issues };
}

function renderTable(items){
  const tb = $("#table tbody");
  tb.innerHTML = "";
  const base = $("#imgBasePath").value || "./assets/fotos/";
  const ext = $("#imgExt").value || ".webp";
  items.forEach((p, i) => {
    const slug = slugify(p.name);
    const fileGuess = guessImageFromName(p.name, ext);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><code>${p.sku||""}</code></td>
      <td>${p.name||""}</td>
      <td>${p.price.toFixed ? p.price.toFixed(2) : p.price}</td>
      <td>${(p.sizes||[]).join(", ")}</td>
      <td>${p.color||""}</td>
      <td>${p.highlight ? "true" : "false"}</td>
      <td><code>${slug}</code></td>
      <td>
        <div class="muted">pasta: ${base}</div>
        <input data-idx="${i}" class="imgname" value="${fileGuess}" style="width:100%">
      </td>
    `;
    tb.appendChild(tr);
  });
  $("#count").textContent = `${items.length} produto(s) parseado(s)`;
}

function buildObjects(items){
  const useImageBase = $("#imgFormat").value === "imageBase";
  const base = $("#imgBasePath").value || "./assets/fotos/";
  const names = $$(".imgname").map((el)=> el.value.trim().replace(/^\/+/,""));

  return items.map((p, i) => {
    const slug = slugify(p.name);
    const url = `/produto/${slug}`;
    const file = names[i] || guessImageFromName(p.name, $("#imgExt").value || ".webp");
    if(useImageBase){
      const baseNoExt = file.replace(/\.[a-z0-9]+$/i,"");
      return {
        sku: p.sku,
        name: p.name,
        price: p.price,
        sizes: p.sizes,
        color: p.color,
        imageBase: (base + baseNoExt).replace(/\/+/g,"/"),
        url,
        highlight: !!p.highlight
      };
    } else {
      return {
        sku: p.sku,
        name: p.name,
        price: p.price,
        sizes: p.sizes,
        color: p.color,
        image: (base + file).replace(/\/+/g,"/"),
        url,
        highlight: !!p.highlight
      };
    }
  });
}

function copyToClipboard(text){
  navigator.clipboard?.writeText(text).then(()=> {
    const btn = $("#btn-copy");
    btn.textContent = "Copiado!";
    btn.classList.add("ok");
    setTimeout(()=>{ btn.textContent="Copiar JS (products[])"; btn.classList.remove("ok"); }, 1200);
  });
}

$("#btn-parse").addEventListener("click", ()=>{
  const { items, issues } = parseProducts($("#raw").value);
  if(!items.length){ alert("Nada para parsear. Confira o texto."); return; }
  $("#results").style.display = "block";
  $("#warn").textContent = issues.join("  •  ");
  renderTable(items);
  // guarda na sessão
  window.__parsed = items;
});

$("#btn-copy").addEventListener("click", ()=>{
  if(!window.__parsed){ return; }
  const arr = buildObjects(window.__parsed);
  const js = "const products = " + JSON.stringify(arr, null, 2) + ";";
  copyToClipboard(js);
});

$("#btn-download").addEventListener("click", ()=>{
  if(!window.__parsed){ return; }
  const arr = buildObjects(window.__parsed);
  const blob = new Blob([JSON.stringify(arr, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "products.json";
  a.click();
  URL.revokeObjectURL(a.href);
});
</script>
</body>
</html>
